package main

import (
	"bytes"
	"crypto/md5"
	"fmt"
	"go/format"
	"io"
	"log"
	"os"
	"path"
	"path/filepath"
	"reflect"
	"sort"
	"strings"
	"text/template"
)

func main() {
	var name string
	var file string
	switch len(os.Args) {
	case 3:
		name = os.Args[2]
		file = os.Args[1]
	case 2:
		file = os.Args[1]
		if file != "-" {
			name = file
		} else {
			name = "sample"
		}
	case 1:
		name = "sample"
		file = "-"
	default:
		log.Fatal("too many arguments")
	}
	var f io.Reader
	switch file {
	case "-":
		f = os.Stdin
	default:
		fic, err := os.Open(file)
		if err != nil {
			log.Fatal(err)
		}
		defer fic.Close()
		f = fic
	}
	/*
		content, err := ioutil.ReadAll(os.Stdin)
		portraitLeft := md5.Sum(content[2480343:2551487]))
		landscapeLeft := md5.Sum(content[93530:2551487]))
		sigPortraitLeft := []byte{198, 104, 128, 15, 244, 220, 201, 184, 37, 102, 121, 114, 251, 0, 76, 100}

		if compareSig(sigPortraitLeft, portraitLeft) {
			fmt.Println("portrait left")
		}
	*/
	b := make([]byte, 1)
	content, err := io.ReadAll(f)
	rdr := bytes.NewReader(content)
	groups := make([][2]int, 0)
	window := 200
	var inGroup bool
	var startGroup int
	var lastOff int
	var off int
	for off = 0; err == nil; off++ {
		_, err = rdr.Read(b)
		if reflect.DeepEqual(b, []byte{0}) {
			if !inGroup {
				startGroup = off
				inGroup = true
				groups = append(groups, [2]int{startGroup, 0})
			}
			if off-startGroup > window {
				groups[len(groups)-1][1] = lastOff
				inGroup = false
			}
			lastOff = off
		}
	}
	if groups[len(groups)-1][1] == 0 {
		groups = groups[:len(groups)-1]
	}
	sort.Sort(sort.Reverse(byGroupSize(groups)))
	displayCodeChecking(name, content, groups[0])
}

type byGroupSize [][2]int

func (b byGroupSize) Len() int {
	return len(b)
}
func (b byGroupSize) Swap(i, j int) {
	b[i], b[j] = b[j], b[i]
}
func (b byGroupSize) Less(i, j int) bool {
	return b[i][1]-b[i][0] < b[j][1]-b[j][0]
}

func displayCodeChecking(name string, content []byte, g [2]int) {
	name = path.Base(name)
	var extension = filepath.Ext(name)
	name = name[0 : len(name)-len(extension)]

	t := template.Must(template.New("sample").Parse(tmpl))
	type data struct {
		Name  string
		Sig   string
		Start int
		End   int
	}
	var b bytes.Buffer
	lowered := strings.ToLower(name)
	titleName := strings.ToUpper(lowered[:1]) + lowered[1:]
	err := t.Execute(&b, data{
		Name:  titleName,
		Sig:   strings.Replace(strings.Trim(fmt.Sprint(md5.Sum(content[g[0]:g[1]])), "[]"), " ", ",", -1),
		Start: g[0],
		End:   g[1],
	})
	if err != nil {
		log.Fatal(err)
	}
	out, err := format.Source(b.Bytes())
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println(string(out))
}

// portraitLeft := []int{2480343,2480344,2480345,2480346,2480347,2480348,2480349,2480350,2480351,2480352,2482212,2482213,2482214,2482215,2482216,2482217,2482218,2482219,2482220,2482221,2482222,2482223,2482224,2482225,2482226,2482227,2484082,2484083,2484084,2484085,2484086,2484087,2484088,2484089,2484090,2484091,2484092,2484093,2484094,2484095,2484096,2484097,2484098,2484099,2484100,2484101,2485953,2485954,2485955,2485956,2485957,2485958,2485959,2485968,2485969,2485970,2485971,2485972,2485973,2485974,2487823,2487824,2487825,2487826,2487827,2487828,2487843,2487844,2487845,2487846,2487847,2487848,2489694,2489695,2489696,2489697,2489698,2489717,2489718,2489719,2489720,2489721,2491565,2491566,2491567,2491568,2491569,2491590,2491591,2491592,2491593,2491594,2493437,2493438,2493439,2493440,2493463,2493464,2493465,2493466,2495308,2495309,2495310,2495311,2495336,2495337,2495338,2495339,2497179,2497180,2497181,2497182,2497209,2497210,2497211,2497212,2499051,2499052,2499053,2499061,2499062,2499063,2499064,2499082,2499083,2499084,2500922,2500923,2500924,2500925,2500931,2500932,2500933,2500934,2500935,2500936,2500937,2500938,2500954,2500955,2500956,2500957,2502794,2502795,2502796,2502803,2502804,2502805,2502806,2502807,2502808,2502809,2502810,2502827,2502828,2502829,2504665,2504666,2504667,2504668,2504675,2504676,2504677,2504678,2504679,2504680,2504681,2504682,2504699,2504700,2504701,2504702,2506537,2506538,2506539,2506546,2506547,2506548,2506549,2506550,2506551,2506552,2506553,2506554,2506555,2506572,2506573,2506574,2508409,2508410,2508411,2508419,2508420,2508421,2508422,2508423,2508424,2508425,2508426,2508444,2508445,2508446,2510281,2510282,2510283,2510291,2510292,2510293,2510294,2510295,2510296,2510297,2510298,2510316,2510317,2510318,2512153,2512154,2512155,2512164,2512165,2512166,2512167,2512168,2512169,2512188,2512189,2512190,2514024,2514025,2514026,2514027,2514037,2514038,2514039,2514040,2514060,2514061,2514062,2514063,2515896,2515897,2515898,2515899,2515932,2515933,2515934,2515935,2517768,2517769,2517770,2517771,2517804,2517805,2517806,2517807,2519641,2519642,2519643,2519676,2519677,2519678,2521513,2521514,2521515,2521548,2521549,2521550,2523385,2523386,2523387,2523420,2523421,2523422,2525257,2525258,2525259,2525292,2525293,2525294,2527129,2527130,2527131,2527132,2527163,2527164,2527165,2527166,2529002,2529003,2529004,2529035,2529036,2529037,2530874,2530875,2530876,2530877,2530906,2530907,2530908,2530909,2532747,2532748,2532749,2532778,2532779,2532780,2534619,2534620,2534621,2534622,2534649,2534650,2534651,2534652,2536492,2536493,2536494,2536495,2536520,2536521,2536522,2536523,2538365,2538366,2538367,2538368,2538391,2538392,2538393,2538394,2540238,2540239,2540240,2540241,2540262,2540263,2540264,2540265,2542111,2542112,2542113,2542114,2542115,2542132,2542133,2542134,2542135,2542136,2543984,2543985,2543986,2543987,2543988,2543989,2544002,2544003,2544004,2544005,2544006,2544007,2545857,2545858,2545859,2545860,2545861,2545862,2545863,2545864,2545871,2545872,2545873,2545874,2545875,2545876,2545877,2545878,2547731,2547732,2547733,2547734,2547735,2547736,2547737,2547738,2547739,2547740,2547741,2547742,2547743,2547744,2547745,2547746,2547747,2547748,2549605,2549606,2549607,2549608,2549609,2549610,2549611,2549612,2549613,2549614,2549615,2549616,2549617,2549618,2551480,2551481,2551482,2551483,2551484,2551485,2551486,2551487}
// landsxcapeLeft := []int{76694,76695,76696,76697,76698,76699,76700,76701,76702,78563,78564,78565,78566,78567,78568,78569,78570,78571,78572,78573,78574,78575,78576,78577,80433,80434,80435,80436,80437,80438,80439,80440,80441,80442,80443,80444,80445,80446,80447,80448,80449,80450,80451,82304,82305,82306,82307,82308,82309,82310,82318,82319,82320,82321,82322,82323,82324,82325,84174,84175,84176,84177,84178,84179,84193,84194,84195,84196,84197,84198,86045,86046,86047,86048,86049,86067,86068,86069,86070,86071,87916,87917,87918,87919,87920,87941,87942,87943,87944,89787,89788,89789,89790,89791,89814,89815,89816,89817,91659,91660,91661,91662,91687,91688,91689,91690,93530,93531,93532,93533,93560,93561,93562,93563,95401,95402,95403,95404,95433,95434,95435,97273,97274,97275,97276,97305,97306,97307,97308,99145,99146,99147,99178,99179,99180,101016,101017,101018,101019,101050,101051,101052,102888,102889,102890,102922,102923,102924,102925,104760,104761,104762,104795,104796,104797,106632,106633,106634,106667,106668,106669,108503,108504,108505,108506,108539,108540,108541,110375,110376,110377,110411,110412,110413,112247,112248,112249,112283,112284,112285,114119,114120,114121,114132,114133,114134,114135,114155,114156,114157,115991,115992,115993,115994,116002,116003,116004,116005,116006,116007,116008,116027,116028,116029,117864,117865,117866,117874,117875,117876,117877,117878,117879,117880,117881,117899,117900,117901,119736,119737,119738,119745,119746,119747,119748,119749,119750,119751,119752,119753,119771,119772,119773,121608,121609,121610,121617,121618,121619,121620,121621,121622,121623,121624,121625,121642,121643,121644,121645,123480,123481,123482,123483,123489,123490,123491,123492,123493,123494,123495,123496,123497,123514,123515,123516,125353,125354,125355,125362,125363,125364,125365,125366,125367,125368,125369,125386,125387,125388,127225,127226,127227,127228,127234,127235,127236,127237,127238,127239,127240,127257,127258,127259,127260,129097,129098,129099,129100,129108,129109,129110,129111,129129,129130,129131,130970,130971,130972,130973,131000,131001,131002,131003,132843,132844,132845,132846,132871,132872,132873,132874,134715,134716,134717,134718,134719,134742,134743,134744,134745,136588,136589,136590,136591,136592,136613,136614,136615,136616,138461,138462,138463,138464,138465,138483,138484,138485,138486,138487,140334,140335,140336,140337,140338,140339,140353,140354,140355,140356,140357,140358,142208,142209,142210,142211,142212,142213,142214,142223,142224,142225,142226,142227,142228,142229,144081,144082,144083,144084,144085,144086,144087,144088,144089,144090,144091,144092,144093,144094,144095,144096,144097,144098,144099,144100,145955,145956,145957,145958,145959,145960,145961,145962,145963,145964,145965,145966,145967,145968,145969,145970,147830,147831,147832,147833,147834,147835,147836,147837,147838,147839}

// 2480343:2551487
